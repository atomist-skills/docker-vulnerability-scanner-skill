/*
 * Copyright Â© 2021 Atomist, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import { datalog, EventHandler, status } from "@atomist/skill";
import * as _ from "lodash";

import { Configuration } from "../configuration";
import { TransactPackageOnDockerfile } from "../types";

export const handler: EventHandler<
	TransactPackageOnDockerfile,
	Configuration
> = async ctx => {
	const file = ctx.data.file;
	const runLines = file.lines.filter(l => l.instruction === "RUN");
	const packages: Array<{
		name: string;
		version?: string;
		lineNumber: number;
	}> = [];
	runLines.forEach(l =>
		l.argsString
			.split("&&")
			.filter(i => /apt-get\s*install/.test(i))
			.map(i => i.trim())
			.forEach(i => {
				i.split(" ")
					.slice(2)
					.map(p => p.trim())
					.filter(p => !p.startsWith("-"))
					.forEach(p => {
						const name = p.split("=")?.[0]?.trim();
						const version = p.split("=")?.[1]?.trim();
						packages.push({
							name,
							version,
							lineNumber: l.number,
						});
					});
			}),
	);
	const entities = [
		datalog.entity("docker/file", "$file", {
			"db/id": file.id,
		}),
	];
	_.forEach(_.groupBy(packages, "lineNumber"), (v, k) => {
		const lp = v.map(p =>
			datalog.entity("os/package", {
				name: p.name,
				installedVersion: p.version,
			}),
		);
		entities.push(
			...lp,
			datalog.entity("docker.file/line", {
				"file": "$file",
				"number": k,
				"docker.file.run/packages": {
					set: datalog.entityRefs(lp),
				},
			}),
		);
	});

	await ctx.datalog.transact(entities);

	return status.success(
		`Extracted installed os packages from \`${file.path}\``,
	);
};
