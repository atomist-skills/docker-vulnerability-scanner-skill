/*
 * Copyright Â© 2021 Atomist, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import { subscription } from "@atomist/skill";

export type ExtendedDockerRegistry = subscription.datalog.DockerRegistry & {
	serviceAccount: string;
};

export type PullableDockerImage = Omit<
	subscription.datalog.DockerImage,
	"labels" | "tags"
> & {
	repository: {
		baselines: Array<{
			analysis: {
				image: Omit<
					subscription.datalog.DockerImage,
					"labels" | "tags"
				>;
			};
		}>;
	};
};

export interface RescanImage {
	image: PullableDockerImage | PullableDockerImage[];
	manifestList: Array<{
		digest: string;
		images: PullableDockerImage[];
	}>;
	commit: subscription.datalog.Commit;
	registry: ExtendedDockerRegistry;
}

export type TrivyReport = Array<{
	Target: string;
	Type: string;
	Vulnerabilities: Array<{
		VulnerabilityID: string;
		PkgName: string;
		InstalledVersion: string;
		FixedVersion?: string;
		Title?: string;
		Description: string;
		Severity: "UNKNOWN" | "LOW" | "MEDIUM" | "HIGH" | "CRITICAL";
		PublishedDate: string;
		LastModifiedDate: string;
		CVSS: {
			nvd: {
				V3Vector: string;
				V3Score: number;
				V2Vector: string;
				V2Score: number;
			};
		};
		Layer: {
			Digest: string;
			DiffID: string;
		};
	}>;
}>;

export interface TransactLayers {
	registry: Array<ExtendedDockerRegistry & { id: string }>;
	commit: subscription.datalog.Commit;
	image: subscription.datalog.DockerImage;
	file: subscription.datalog.OnDockerFile["file"];
}

export interface ScanImage {
	registry: ExtendedDockerRegistry[];
	commit: subscription.datalog.Commit;
	image: PullableDockerImage;
}

export interface ScanImageUnlinked {
	registry: ExtendedDockerRegistry[];
	image: PullableDockerImage;
	commit?: subscription.datalog.Commit;
}

export interface TransactPackageOnDockerfile {
	file: subscription.datalog.OnDockerFile["file"];
}
