[:find
 (pull ?commit [{:git.commit/repo [:git.repo/source-id
                                   :git.repo/name
                                   :git.provider/url
                                   {:git.repo/org [:github.org/installation-token
                                                   :git.org/name
                                                   :git.provider/url]}]}
                {:git.commit/email [:email.email/address]}
                {:git.commit/author [:git.user/login
                                     :git.user/name
                                     {:git.user/emails [:email.email/address]}]}
                :git.commit/sha])
 (pull ?docker-image [:docker.image/image
                      {:docker.image/repository [*]}])

 (pull ?docker-registry [:docker.registry/type
                         :docker.registry/secret
                         :docker.registry/username
                         :docker.registry/server-url])

 :in $ $before-db %
 :where
 (tx-entity-attr-value :docker.image/image ?docker-image _)
 (capability-configuration "atomist" "DockerRegistry" "analysis" ?docker-registry)
 [?docker-image :docker.image/sha ?sha]
 [?commit :git.commit/sha ?sha]
]
