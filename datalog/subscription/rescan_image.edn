[:find
  (pull
   ?docker-image
   [:schema/entity-type
    :docker.image/digest
    :docker.image/tags
    :docker.image/sha
    {:docker.image/labels [:docker.image.label/name
                           :docker.image.label/value]}
    {:docker.image/repository [:docker.repository/host
                               (:docker.repository/repository
                                :as
                                :name)]}])
 (pull
  ?docker-registry
  [:schema/entity-type
   :docker.registry/type
   :docker.registry/secret
   :docker.registry/username
   :docker.registry/server-url])
 :in $ $before-db %
 :where
 (tx-schedule ?schedule-parameter-name ?schedule-timezone)
 (or-join [?docker-registry]
   (capability-configuration
     "atomist"
     "DockerRegistry"
     "analysis"
     ?docker-registry)
   [(ground "empty") ?docker-registry])

 ;; all head commits of default branch
 [?ref :git.ref/type :git.ref.type/branch]
 (is-default-branch? ?ref)
 [?ref :git.ref/commit ?commit]
 [?commit :git.commit/sha ?commit-sha]

 ;; all docker images
 [?docker-image :docker.image/sha ?commit-sha]]

;; TODO add support re-scanning base images
