[:find
 (pull
   ?image
   [:schema/entity-type
    {(:docker.platform/_image :as :docker.image/platform) [:docker.platform/architecture
                                                           :docker.platform/os]}
    {:docker.image/repository [:docker.repository/host
                               (:docker.repository/repository :as :name)
                               {(:baseline.docker.image/_repository :as :baseline.docker.image/baseline) [:baseline.docker.image/type
                                                                                                          {:baseline.docker.image/current [{:analysis.discovery/image [:docker.image/digest]}]}]}]}
    :docker.image/digest
    :docker.image/tags
    {:docker.manifest-list/repository [:docker.repository/host
                                       (:docker.repository/repository
                                         :as
                                         :name)]}
    :docker.manifest-list/digest
    :docker.manifest-list/tags
    {:docker.manifest-list/images [:docker.image/digest
                                   {(:docker.platform/_image :as :docker.image/platform) [:docker.platform/architecture
                                                                                          :docker.platform/os]}
                                   {:docker.image/repository [:docker.repository/host
                                                              (:docker.repository/repository :as :name)
                                                              {(:baseline.docker.image/_repository :as :baseline.docker.image/baseline) [:baseline.docker.image/type
                                                                                                                                         {:baseline.docker.image/current [{:analysis.discovery/image [:docker.image/digest]}]}]}]}]}])
 (pull
   ?commit
   [:schema/entity-type
    {(:git.ref/_commit :as :git.ref/refs) [:git.ref/name
                                           :git.ref/type]}
    {:git.commit/repo [:git.repo/name
                       :git.repo/default-branch
                       {:git.repo/org [:github.org/installation-token
                                       :git.org/name
                                       (:git.org/provider-base-url
                                         :as
                                         :base-url)
                                       :git.provider/url]}]}
    {:git.commit/author [:git.user/name
                         :git.user/login
                         {:git.user/emails [:email.email/address]}]}
    :git.commit/sha
    :git.commit/message])
 (pull
   ?docker-image
   [:schema/entity-type
    :docker.image/digest
    :docker.image/tags
    :docker.image/sha
    {(:docker.platform/_image :as :docker.image/platform) [:docker.platform/architecture
                                                           :docker.platform/os]}
    {:docker.image/repository [:docker.repository/host
                               (:docker.repository/repository :as :name)
                               {(:baseline.docker.image/_repository :as :baseline.docker.image/baseline) [:baseline.docker.image/type
                                                                                                          {:baseline.docker.image/current [{:analysis.discovery/image [:docker.image/digest]}]}]}]}])
 (pull
   ?docker-registry
   [:schema/entity-type
    :docker.registry/type
    :docker.registry/secret
    :docker.registry/username
    :docker.registry/server-url])
 :in $ $before-db % ?ctx
 :where
 (schedule-tx ?ctx ?schedule-parameter-name ?schedule-timezone)

 ;; all head commits of default branch
 [?ref :git.ref/type :git.ref.type/branch]
 (is-default-branch? ?ref)
 [?ref :git.ref/commit ?commit]
 [?commit :git.commit/sha ?commit-sha]

 ;; all docker images
 [?docker-image :docker.image/sha ?commit-sha]

 ;;[?platform :docker.platform/image ?docker-image]
 ;;[?platform :docker.platform/os "linux"]

 (or-join [?docker-registry ?ctx]
   (skill-capability-configuration ?ctx
     "atomist"
     "DockerRegistry"
     "analysis"
     ?docker-registry)
   [(ground "empty") ?docker-registry])

 ;; resolve all images and manifest-list currently used in FROM lines
 [?docker-image :docker.image/docker-file ?docker-file]
 [?other-from-line :docker.file.line/file ?docker-file]
 [?other-from-line :docker.file.line/instruction "FROM"]
 (or-join [?other-from-line ?image]
   (and
     [?other-from-line :docker.file.from/digest ?digest]
     [?image :docker.image/digest ?digest]
     ;;[?other-platform :docker.platform/image ?image]
     ;;[?other-platform :docker.platform/os "linux"]
     )
   (and
     [?other-from-line :docker.file.from/digest ?digest]
     [?image :docker.manifest-list/digest ?digest]
     ;;[?other-platform :docker.platform/image ?image]
     ;;[?other-platform :docker.platform/os "linux"]
     )
   (and
     [(missing? $ ?other-from-line :docker.file.from/digest)]
     [(ground "scratch") ?image])
   )]

