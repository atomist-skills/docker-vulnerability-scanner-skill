[:find
 (atomist/serialize-on ?tuple)
 (pull
   ?docker-image
   [:schema/entity-type
    :docker.image/digest
    :docker.image/tags
    :docker.image/sha
    {(:docker.platform/_image :as :docker.image/platform) [:docker.platform/architecture
                                                           :docker.platform/os]}
    {:docker.image/repository [:docker.repository/host
                               (:docker.repository/repository :as :name)]}])
 (pull
   ?docker-registry
   [:schema/entity-type
    :docker.registry/type
    :docker.registry/secret
    :docker.registry/username
    :docker.registry/server-url
    :docker.registry.gcr/service-account
    :docker.registry.ecr/arn
    :docker.registry.ecr/external-id
    :docker.registry.ecr/region])
 :in $ $before-db % ?ctx
 :where
 (schedule-tx ?ctx ?schedule-parameter-name ?schedule-timezone)

 [?ref :git.ref/type :git.ref.type/branch]
 [?ref :git.ref/commit ?commit]
 [?commit :git.commit/sha ?commit-sha]

 ;; all docker images
 [?docker-image :docker.image/sha ?commit-sha]
 [?docker-image :docker.image/digest ?digest]

 [(tuple ?digest "docker-vulnerability-scanner-skill/rescan") ?tuple]

 (or-join [?docker-registry ?ctx]
   (skill-capability-configuration ?ctx
     "atomist"
     "DockerRegistry"
     "analysis"
     ?docker-registry)
   [(ground "empty") ?docker-registry])]

